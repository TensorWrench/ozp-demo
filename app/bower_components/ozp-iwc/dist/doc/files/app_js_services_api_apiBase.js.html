<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/services/api/apiBase.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.3</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.AjaxPersistenceQueue.html">ozpIwc.AjaxPersistenceQueue</a></li>
            
                <li><a href="../classes/ozpIwc.ApiBase.html">ozpIwc.ApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.html">ozpIwc.apiFilter</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.Function.html">ozpIwc.apiFilter.Function</a></li>
            
                <li><a href="../classes/ozpIwc.ApiNode.html">ozpIwc.ApiNode</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.BadActionError.html">ozpIwc.BadActionError</a></li>
            
                <li><a href="../classes/ozpIwc.BadContentError.html">ozpIwc.BadContentError</a></li>
            
                <li><a href="../classes/ozpIwc.BadRequestError.html">ozpIwc.BadRequestError</a></li>
            
                <li><a href="../classes/ozpIwc.BadResourceError.html">ozpIwc.BadResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.BadStateError.html">ozpIwc.BadStateError</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.ClientParticipant.html">ozpIwc.ClientParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataNode.html">ozpIwc.DataNode</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsInFlightNode.html">ozpIwc.IntentsInFlightNode</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Bound.html">ozpIwc.Lifespan.Bound</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Ephemeral.html">ozpIwc.Lifespan.Ephemeral</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Persistent.html">ozpIwc.Lifespan.Persistent</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApi.html">ozpIwc.LocksApi</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApiValue.html">ozpIwc.LocksApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesNode.html">ozpIwc.NamesNode</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.NoActionError.html">ozpIwc.NoActionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoMatchError.html">ozpIwc.NoMatchError</a></li>
            
                <li><a href="../classes/ozpIwc.NoPermissionError.html">ozpIwc.NoPermissionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoResourceError.html">ozpIwc.NoResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.standardApiFilters.html">ozpIwc.standardApiFilters</a></li>
            
                <li><a href="../classes/ozpIwc.SystemNode.html">ozpIwc.SystemNode</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.service.html">bus.service</a></li>
            
                <li><a href="../modules/bus.service.Type.html">bus.service.Type</a></li>
            
                <li><a href="../modules/bus.service.Value.html">bus.service.Value</a></li>
            
                <li><a href="../modules/bus.service.Value.Persistance.html">bus.service.Value.Persistance</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/services/api/apiBase.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">


/**
 * Service API classes of the bus.
 * @module bus.service
 * @submodule bus.service.Type
 */

/**
 * The base class for APIs. Use {{#crossLink &quot;ozpIwc.createApi&quot;}}{{/crossLink}} to subclass
 * this.
 * 
 * Leader State Management
 * =======================
 * The base API uses locks.api to always have a single leader at a time.  An api instance goes
 * through a linear series of states:  member -&gt; loading -&gt; leader
 * * __member__ does not service requests
 * * __loading__ is a transitory state between acquiring the leader lock and being ready to serve requests
 * * __leader__ actively serves requests and broadcasts a death scream upon shutdown
 *
 * The member state has two substates-- ready and dormant
 *  * __ready__ queues requests in case it has to become leader.  switches back to dormant on discovering a leader
 *  * __dormant__ silently drops requests.  Upon hearing a deathScream, it switches to ready.

 * @class ApiBase
 * @module ozpIwc
 * @namespace ozpIwc
 * @constructor
 * @param {Object} config
 * @param {String} config.name The api address (e.g. &quot;names.api&quot;)
 * @param {ozpIwc.ClientMixin} [config.participant] The connection to use for communication
 * @param {ozpIwc.Router} [config.router=ozpIwc.defaultRouter] The router to connect to
 */
ozpIwc.ApiBase=function(config) {
	if(!config.name) {
        throw Error(&quot;API must be configured with a name&quot;);
    }
    this.participant=config.participant || new ozpIwc.ClientParticipant({internal:true});

    this.name=config.name;
    this.coordinationAddress=&quot;coord.&quot; + this.name;
    
    
    this.events = new ozpIwc.Event();
    this.events.mixinOnOff(this);

    this.endpoints=[];
    this.data={};
    this.watchers={};
    this.collectors=[];
    this.changeList={};
    this.leaderState=&quot;member&quot;;

    
    this.router=config.router || ozpIwc.defaultRouter;
    this.router.registerParticipant(this.participant);
    this.router.registerMulticast(this.participant,[this.name,this.coordinationAddress]);

    var self=this;
    this.participant.on(&quot;receive&quot;,function(packetContext) {
        self.receivePacketContext(packetContext);
    });

    this.transitionToMemberReady();

    this.logPrefix=&quot;[&quot; + this.name + &quot;/&quot; + this.participant.address +&quot;] &quot;;
    
    this.leaderPromise=this.participant.send({
        dst: &quot;locks.api&quot;,
        resource: &quot;/mutex/&quot;+this.name,
        action: &quot;lock&quot;
    }).then(function(pkt) {
        var resolve;

        // Delay loading for deathScreams to flow in.
        var delayed = new Promise(function(res,rej){
            resolve = res;
        });

        window.setTimeout(function(){
            resolve();
        },1000);

        return delayed;
    }).then(function(){
        self.transitionToLoading();
    });
    
    this.leaderPromise.catch(function(e) {
        console.error(&quot;Error registering for leader mutex [address=&quot;+self.participant.address+&quot;,api=&quot;+self.name+&quot;]&quot;,e);
    });

    ozpIwc.util.addEventListener(&quot;beforeunload&quot;,function(){
        self.shutdown();
    });
};


/**
 * Generates a unique key with the given prefix.
 * @param {String} prefix
 * @returns {String}
 */
ozpIwc.ApiBase.prototype.createKey = function(prefix) {
    prefix = prefix || &quot;&quot;;
    var key;
    do {
        key = prefix + ozpIwc.util.generateId();
    } while (key in this.data);
    return key;
};

/**
 * A handler function for when a node is created. Can be overridden by inherited APIs.
 * @method createdHandler
 * @param node
 */
ozpIwc.ApiBase.prototype.createdHandler=function(node){
    //Whenever a node is created update the collector&#x27;s lists.
    this.updateCollections();
};

/**
 * A handler function called after a node is changed but before it&#x27;s watchers are notified.
 * @method changedHandler
 * @param {Object} node
 * @param {Object} entity
 * @param {Object} packetContext
 */
ozpIwc.ApiBase.prototype.changedHandler =function(node,entity,packetContext) {
    //var culprit = packetContext.src;
    var lifespanFns = ozpIwc.Lifespan.getLifespanFunctionality(node.lifespan);
    if(lifespanFns.shouldPersist()) {
        this.persistenceQueue.queueNode(this.name + &quot;/&quot; + node.resource, node);
    }
};

/**
 * A handler function called when an instance of this API has disconnected from the bus.
 * @method disconnectHandler
 * @param {String} address
 */
ozpIwc.ApiBase.prototype.disconnectHandler =function(address) {
    var self = this;
    ozpIwc.object.eachEntry(self.data,function(resource,node) {
        var lifespanFns = ozpIwc.Lifespan.getLifespanFunctionality(node.lifespan);
        if(lifespanFns.shouldDelete(node.lifespan,address)){
            self.markForChange(node);
            node.markAsDeleted();
        }
    });
    self.resolveChangedNodes();
};
//===============================================================
// Default methods that can be overridden by subclasses
//===============================================================
/**
 * Create the data that needs to be handed off to the new leader.
 *
 * __Intended to be overridden by subclasses__
 * 
 * Subsclasses can override this if they need to add additional
 * handoff data.  This MUST be a synchronous call that returns immediately.
 *
 * @method createDeathScream
 * @return {Object} the data that will be passed to the new leader
 */
ozpIwc.ApiBase.prototype.createDeathScream=function() {
    return {
        watchers: this.watchers,
        collectors: this.collectors,
        data: ozpIwc.object.eachEntry(this.data,function(k,v) {
            return v.serializeLive();
        })
    };
};

/**
 * Gathers the desired preference from the data API.
 * @method getPreference
 * @param {String} prefName
 * @returns {Promise}
 */
ozpIwc.ApiBase.prototype.getPreference=function(prefName) {
    return this.participant.send({
        dst: &quot;data.api&quot;,
        resource: &quot;/ozp/iwc/&quot;+this.name+&quot;/&quot;+prefName,
        action: &quot;get&quot;
    }).then(function(reply) {
        return reply.entity;
    });
};

/**
 * Called when the API has become the leader, but before it starts
 * serving data.  Receives the deathScream of the previous leader
 * if available, otherwise undefined.
 * 
 * __Intended to be overridden by subclasses__
 * 
 * Subsclasses can override this to load data from the server.
 *  
 * @method initializeData
 * @param {object} deathScream
 * @return {Promise} a promise that resolves when all data is loaded.
 */
ozpIwc.ApiBase.prototype.initializeData=function(deathScream) {
    deathScream=deathScream || { watchers: {}, collectors: [], data: []};
    this.watchers=deathScream.watchers;
    this.collectors = deathScream.collectors;
    deathScream.data.forEach(function(packet) {
        this.createNode({resource: packet.resource}).deserializeLive(packet);
    },this);

    this.updateCollections();
    if(this.endpoints) {
        var self=this;
        return Promise.all(this.endpoints.map(function(u) {
          var e=ozpIwc.endpoint(u.link) ;
          return self.loadFromEndpoint(e,u.headers).catch(function(e) {
              ozpIwc.log.error(self.logPrefix,&quot;load from endpoint &quot;,e,&quot; failed: &quot;,e);
          });
        }));
    } else {
        return Promise.resolve();
    }
};

/**
 * Creates a node appropriate for the given config, puts it into this.data,
 * and fires off the right events.
 *  
 * @method createNode
 * @param {Object} config The ApiNode configuration.
 * @return {ozpIwc.ApiNode}
 */
ozpIwc.ApiBase.prototype.createNode=function(config,NodeType) {
    var n=this.createNodeObject(config,NodeType);
		this.data[n.resource]=n;
		this.events.trigger(&quot;createdNode&quot;,n);
		return n;
};



/**
 * Creates a node appropriate for the given config.  This does
 * NOT add the node to this.data.  Default implementation returns
 * a plain ozpIwc.ApiNode.
 * 
 * __Intended to be overridden by subclasses__
 * 
 * Subsclasses can override this for custom node types that may vary
 * from resource to resource.
 * 
 * @method createNodeObject
 * @param {Object} config The ApiNode configuration.
 * @param {Function} NodeType The contructor call for the given node type to be created.
 * @return {ozpIwc.ApiNode}
 */
ozpIwc.ApiBase.prototype.createNodeObject=function(config,NodeType) {
    if(NodeType) {
        return new NodeType(config);
    } else {
        return new ozpIwc.ApiNode(config);
    }
};

//===============================================================
// Leader state management
//===============================================================

/**
 * @method transitionToLoading
 * @private
 * @return {Promise} a promise that resolves when all data is loaded.
 */
ozpIwc.ApiBase.prototype.transitionToLoading=function() {
    var self=this;
    if(this.leaderState !== &quot;member&quot;) {
				ozpIwc.log.error(this.logPrefix+&quot;transition to loading called in an invalide state:&quot;,this.leaderState);
        return Promise.reject(this.logPrefix+&quot;transition to loading called in an invalide state:&quot;,this.leaderState);
    }
		ozpIwc.log.debug(this.logPrefix+&quot;transitioning to loading&quot;);
    this.leaderState=&quot;loading&quot;;
    return this.initializeData(this.deathScream)
        .then(function() {
             self.transitionToLeader();
        },function(e) {
            ozpIwc.log.error(self.logPrefix+&quot;Failed to load data due to &quot;,e);
            self.shutdown();
        });
};

/**
 * @method transitionToLeader
 * @private
 */
ozpIwc.ApiBase.prototype.transitionToLeader=function() {
    if(this.leaderState !== &quot;loading&quot;) {
            ozpIwc.log.error(this.logPrefix+&quot;transition to leader called in an invalid state:&quot;,this.leaderState);
            return;
    }
    ozpIwc.log.debug(this.logPrefix+&quot;transitioning to leader&quot;);
    this.leaderState = &quot;leader&quot;;
    this.broadcastLeaderReady();
    this.deliverRequestQueue();

    this.on(&quot;createdNode&quot;,this.createdHandler,this);
    this.on(&quot;changed&quot;,this.changedHandler,this);
    this.on(&quot;addressDisconnects&quot;,this.disconnectHandler,this);
};

/**
 * Shuts down the api, issuing a deathscream and releasing the lock, if possible.
 * @method shutdown
 * @return 
 */
ozpIwc.ApiBase.prototype.shutdown=function() {
    if(this.leaderState === &quot;leader&quot;) {
        this.broadcastDeathScream(this.createDeathScream());
    }
    
    this.participant.send({
        dst: &quot;locks.api&quot;,
        resource: &quot;/mutex/&quot;+this.name,
        action: &quot;unlock&quot;
    });
};

/**
 * @method transitionToMemberReady
 * @private
 * @param {Object} deathScream
 * @return {Promise}
 */
ozpIwc.ApiBase.prototype.transitionToMemberReady=function(deathScream) {
    if(this.leaderState !== &quot;member&quot;) {
        return;
    }
    this.deathScream=deathScream;
    this.off(&quot;createdNode&quot;,this.createdHandler);
    this.off(&quot;changed&quot;,this.changedHandler);
    this.off(&quot;addressDisconnects&quot;,this.disconnectHandler);
    this.enableRequestQueue();
    return Promise.resolve();
};

/**
 * @method transitionToMemberDormant
 * @private
 * @return {Promise}
 */
ozpIwc.ApiBase.prototype.transitionToMemberDormant=function() {
    if(this.leaderState !== &quot;member&quot;) {
        return;
    }
    this.deathScream=null;
    this.flushRequestQueue();
    return Promise.resolve();
};

//===============================================================
// Data Management
//===============================================================

/**
 * Authorize the request for the given node.
 *  
 * @method checkAuthorization
 * @param {ozpIwc.ApiNode} node
 * @param {Object} context
 * @param {ozpIwc.TransportPacket} packet
 * @param {String} action
 * @return {undefined}
 */
ozpIwc.ApiBase.prototype.checkAuthorization=function(node,context,packet,action) {
    //@TODO: actually implement checking the authorization...
    return true;
};

/**
 * Returns a list of nodes that start with the given prefix.
 *  
 * @method matchingNodes
 * @param {String} prefix
 * @return {ozpIwc.ApiNode[]} a promise that resolves when all data is loaded.
 */
ozpIwc.ApiBase.prototype.matchingNodes=function(prefix) {
    return ozpIwc.object.values(this.data, function(k,node) { 
        return node.resource.indexOf(prefix) ===0 &amp;&amp; !node.deleted;
    });
};


//===============================================================
// Watches
//===============================================================

/**
 * Marks that a node has changed and that change notices may need to 
 * be sent out after the request completes.
 *  
 * @method markForChange
 * @param {ApiNode} nodes...
 */
ozpIwc.ApiBase.prototype.markForChange=function(/*varargs*/) {
    for(var i=0;i&lt;arguments.length;++i) {
        if(Array.isArray(arguments[i])) {
            this.markForChange(arguments[i]);
        } else {
            var resource=arguments[i].resource || &quot;&quot;+arguments[i];
            // if it&#x27;s already marked, skip it
            if(this.changeList.hasOwnProperty(resource)) {
                continue;
            }
            
            var n=this.data[resource];

            this.changeList[resource]=n?n.snapshot():{};
        }
    }
};

/**
 * Marks that a node has changed and that change notices may need to
 * be sent out after the request completes.
 *
 * @method addWatcher
 * @param {String} resource name of the resource to watch
 * @param {Object} watcher
 * @param {String} watcher.resource name of the resource to watch
 * @param {String} watcher.src Address of the watcher
 * @param {String | Number} watcher.replyTo The conversation id that change notices will go to
 */
ozpIwc.ApiBase.prototype.addWatcher=function(resource,watcher) {
    var watchList=this.watchers[resource];
    if(!Array.isArray(watchList)) {
        watchList=this.watchers[resource]=[];
    }

    watchList.push(watcher);
};

/**
 * Removes mark that a node has changed and that change notices may need to
 * be sent out after the request completes.
 *
 * @method removeWatcher
 * @param {String} resource name of the resource to unwatch
 * @param {Object} watcher
 * @param {String} watcher.src Address of the watcher
 * @param {String | Number} watcher.replyTo The conversation id that change notices will go to
 */
ozpIwc.ApiBase.prototype.removeWatcher=function(resource,watcher) {
    var watchList=this.watchers[resource];
    if(watchList) {
        this.watchers[resource]=watchList.filter(function(watch) {
            return watch.src === watcher.src &amp;&amp; watch.replyTo === watcher.msgId;
        });
    }
};


/**
 * Adds the given node to the collector list. It&#x27;s collection list will be updated on api data changes.
 * @method addCollector
 * @param {Object} node
 */
ozpIwc.ApiBase.prototype.addCollector=function(node){
    function isCollector(obj){
        return (obj &amp;&amp; obj.pattern &amp;&amp; obj.collection);
    }

    if(isCollector(node)) {
        var index = this.collectors.indexOf(node.resource);
        if(index &lt; 0){
            this.collectors.push(node.resource);
            this.updateCollectionNode(node);
        }
    }
};


/**
 * Removes the given node from the collector list. It&#x27;s collection list will no longer be updated on api data changes.
 * @method removeCollector
 * @param {Object} node
 */
ozpIwc.ApiBase.prototype.removeCollector=function(node){
    var index = this.collectors.indexOf(node.resource);
    if(index &gt; -1) {
        this.collectors.splice(index, 1);
    }
};

/**
 * Notifies watchers of changes of the resource since the given snapshot.
 * @method resolveChangedNode
 * @param {String} resource
 * @param {Object} snapshot
 * @param {Object} packetContext
 */
ozpIwc.ApiBase.prototype.resolveChangedNode=function(resource,snapshot,packetContext) {
    var node=this.data[resource];
    var watcherList=this.watchers[resource] || [];

    if(!node) {
        return;
    }

    var changes=node.changesSince(snapshot);
    if(!changes) {
        return;
    }

    var permissions=ozpIwc.authorization.pip.attributeUnion(
        changes.oldValue.permissions,
        changes.newValue.permissions
    );

    var entity={
        oldValue: changes.oldValue.entity,
        newValue: changes.newValue.entity,
        oldCollection: changes.oldValue.collection,
        newCollection: changes.newValue.collection,
        deleted: node.deleted
    };

    this.events.trigger(&quot;changed&quot;,node,entity,packetContext);

    watcherList.forEach(function(watcher) {
        // @TODO allow watchers to changes notifications if they have permission to either the old or new, not just both
        this.participant.send({
            &#x27;src&#x27;   : this.participant.name,
            &#x27;dst&#x27;   : watcher.src,
            &#x27;replyTo&#x27; : watcher.replyTo,
            &#x27;response&#x27;: &#x27;changed&#x27;,
            &#x27;resource&#x27;: node.resource,
            &#x27;permissions&#x27;: permissions,
            &#x27;contentType&#x27;: node.contentType,
            &#x27;entity&#x27;: entity
        });
    },this);
};

/**
 * Called after the request is complete to send out change notices.
 *  
 * @method resolveChangedNodes
 * @param {Object} packetContext the packet that caused this change.
 * @private
 */
ozpIwc.ApiBase.prototype.resolveChangedNodes=function(packetContext) {
    this.updateCollections();
    ozpIwc.object.eachEntry(this.changeList,function(resource,snapshot){
        this.resolveChangedNode(resource,snapshot,packetContext);
    },this);
    this.changeList={};
};

/**
 * Itterates over all collectors of the API for updates
 * @method updateCollections
 */
ozpIwc.ApiBase.prototype.updateCollections = function(){
    for(var i in this.collectors){
        var collectorNode = this.data[this.collectors[i]];
        this.updateCollectionNode(collectorNode);
    }
};

/**
 * Removes the collector node resource from the collectors list if deleted. Removes references to nodes in the given
 * collectors collection property if said referenced node is deleted. Adds newly created nodes to the collection
 * property if said node&#x27;s resource matches the collection nodes pattern property.
 *
 * @method updateCollectionNode
 * @param {Object} cNode the collector node to update
 */
ozpIwc.ApiBase.prototype.updateCollectionNode = function(cNode){

    //If the collection node is deleted, stop collecting for it.
    if(cNode.deleted){
        this.removeCollector(cNode);
        return;
    }


    var updatedCollection = this.matchingNodes(cNode.pattern).filter(function(node){
        return !node.deleted;
    }).map(function(node) {
        return node.resource;
    });

    if(!ozpIwc.util.arrayContainsAll(cNode.collection,updatedCollection) || !ozpIwc.util.arrayContainsAll(updatedCollection,cNode.collection)) {
        this.markForChange(cNode);
        cNode.collection = updatedCollection;
        cNode.version++;
    }
};

//===============================================================
// Packet Routing
//===============================================================
/**
 * Sends packets of data from this API to other parts of the IWC bus.
 *
 * @param {Object} fragment
 * @returns {Promise}
 */
ozpIwc.ApiBase.prototype.send=function(fragment) {
    fragment.src=this.name;
    return this.participant.send(fragment);
};

/**
 * Routes a packet received from the participant.
 *  
 * @method receivePacketContext
 * @property {Object} packetContext
 * @private
 */
ozpIwc.ApiBase.prototype.receivePacketContext=function(packetContext) {
    if(packetContext.packet.src===this.participant.address) {
        // drop our own packets
        return Promise.resolve();
    }

    if(packetContext.packet.dst===this.coordinationAddress) {
        return this.receiveCoordinationPacket(packetContext);
    } else if (packetContext.packet.dst === &quot;$bus.multicast&quot;){
        return this.receiveBusPacket(packetContext);
    } else {
        return this.receiveRequestPacket(packetContext);
    }
};

/**
 * Handles packets received with a destination of &quot;$bus.multicast&quot;.
 *
 * @method receiveBusPacket
 * @param {Object} packetContext
 * @returns {*}
 */
ozpIwc.ApiBase.prototype.receiveBusPacket=function(packetContext) {
    var packet=packetContext.packet;
    switch(packet.action) {
        case &quot;connect&quot;:
            this.events.trigger(&quot;addressConnects&quot;,packet.entity.address,packet);
            break;
        case &quot;disconnect&quot;:
            this.removeDeadWatchers(packet.entity.address);
            this.events.trigger(&quot;addressDisconnects&quot;,packet.entity.address,packet);
            break;
    }
    return Promise.resolve();
};

/**
 * If the the given address is watching a resource, it will be removed from the watch list. Router addresses will
 * remove all of its participants watch registrations.
 *
 * @method removeDeadWatchers
 * @param {String} address
 */
ozpIwc.ApiBase.prototype.removeDeadWatchers = function(address){
    var len=address.length;
    ozpIwc.object.eachEntry(this.watchers,function(resource,array) {
        for(var i in array) {
            if (array[i].src.substr(-len) === address) {
                array.splice(i, 1);
            }
        }
    });
};

//===============================================================
// API Request Handling
//===============================================================

/**
 * Routes a request to the proper handler and takes care of overhead
 * such as change requests.
 *  
 * @method receivePacketContext
 * @property {Object} packetContext
 * @private
 */
ozpIwc.ApiBase.prototype.receiveRequestPacket=function(packetContext) {
    var packet=packetContext.packet;

    if(this.isRequestQueueing) {
        this.requestQueue.push(packetContext);
        return Promise.resolve();
    }
    if(this.leaderState !== &quot;leader&quot;){
        return Promise.resolve();
    }
    
    var self=this;
    return new Promise(function(resolve,reject) {
        try {
            packetContext.node=self.data[packet.resource];
            resolve(self.routePacket(packet,packetContext));
        } catch(e) {
            reject(e);
        }
    }).then(function(packetFragment) {
        if(packetFragment) {
            packetFragment.response = packetFragment.response || &quot;ok&quot;;
            packetContext.replyTo(packetFragment);
        }
        self.resolveChangedNodes(packetContext);
    },function(e) {
        if(!e || !e.errorAction) {
            ozpIwc.log.error(self.logPrefix,&quot;Unexpected error: &quot;,e,&quot; packet= &quot;,packet);
        }
        var packetFragment={
            &#x27;src&#x27;: self.name,
            &#x27;response&#x27;: e.errorAction || &quot;errorUnknown&quot;,
            &#x27;entity&#x27;: e.message
        };
        packetContext.replyTo(packetFragment);
    });

};

/**
 * Any request packet that does not match a route ends up here.  By default,
 * it replies with BadAction, BadResource, or BadRequest, as appropriate.
 *  
 * @method receivePacketContext
 * @param {ozpIwc.TransportPacket} packet
 * @param {ozpIwc.TransportPacketContext} context
 */
ozpIwc.ApiBase.prototype.defaultRoute=function(packet,context) {
    switch(context.defaultRouteCause) {
        case &quot;nonRoutablePacket&quot;: // packet doesn&#x27;t have an action/resource, so ignore it
            return;
        case &quot;noAction&quot;: 
            throw new ozpIwc.BadActionError(packet);
        case &quot;noResource&quot;:
            throw new ozpIwc.BadResourceError(packet);
        default:
            throw new ozpIwc.BadRequestError(packet);
    }
};

/**
 * Enables the API&#x27;s request queue, all requests will be held until deliverRequestQueue or flushRequestQueue is called.
 * @method enableRequestQueue
 * @private
 */
ozpIwc.ApiBase.prototype.enableRequestQueue=function() {
    this.isRequestQueueing=true;
    this.requestQueue=[];
};

/**
 * Routes all queued packets and turns off request queueing.
 * @method deliverRequestQueue
 * @private
 */
ozpIwc.ApiBase.prototype.deliverRequestQueue=function() {
    this.isRequestQueueing=false;
    this.requestQueue.forEach(this.receiveRequestPacket,this);
    this.requestQueue=[];
};

/**
 * Empties the queue of requests without processing and turns off queuing.
 * @method flushRequestQueue
 * @private
 */
ozpIwc.ApiBase.prototype.flushRequestQueue=function() {
    this.isRequestQueueing=false;
    this.requestQueue=[];
};



//===============================================================
// API Coordination Handling
//===============================================================
/**
 * Broadcasts to other instances of this API on the bus that it is ready to lead.
 * @method broadcastLeaderReady
 */
ozpIwc.ApiBase.prototype.broadcastLeaderReady=function() {
    this.participant.send({
        dst: this.coordinationAddress,
        action: &quot;announceLeader&quot;
    });
};

/**
 * Broadcasts to other instances of this API on the bus this APIs state.
 * @method broadcastDeathScream
 * @param {Object} deathScream the state data to pass on.
 */
ozpIwc.ApiBase.prototype.broadcastDeathScream=function(deathScream) {
    this.participant.send({
        dst: this.coordinationAddress,
        action: &quot;deathScream&quot;,
        entity: deathScream
    });
};

/**
 * Handles packets received regarding leadership actions.
 * @method receiveCoordinationPacket
 * @param {Object} packetContext
 * @returns {Promise}
 */
ozpIwc.ApiBase.prototype.receiveCoordinationPacket=function(packetContext) {
    var packet=packetContext.packet;
    switch(packet.action) {
        case &quot;announceLeader&quot;:
            return this.transitionToMemberDormant();
        case &quot;deathScream&quot;:
            return this.transitionToMemberReady(packet.entity);
        default:
            ozpIwc.log.error(&quot;Unknown coordination packet: &quot;, packet);
            return Promise.reject(new Error(&quot;Unknown action: &quot; + packet.action + &quot; in &quot; + JSON.stringify(packetContext)));
    }
};

//===============================================================
// Load data from the server
//===============================================================

/**
 * Loads data from the provided endpoint.  The endpoint must point to a HAL JSON document
 * that embeds or links to all resources for this api.
 * 
 * @method loadFromEndpoint
 * @param {ozpIwc.Endpoint} endpoint
 * @param {Array} headers
 * @return {Promise} resolved when all data has been loaded.
 */
ozpIwc.ApiBase.prototype.loadFromEndpoint=function(endpoint,headers) {
    var self=this;
		ozpIwc.log.debug(self.logPrefix+&quot; loading from &quot;,endpoint.name,&quot; -- &quot;,endpoint.baseUrl);
    return endpoint.get(&quot;/&quot;).then(function(data) {

        var response=data.response;
        var embeddedItems=ozpIwc.util.ensureArray((response._embedded &amp;&amp; response._embedded.item) || []);
        var linkedItems=ozpIwc.util.ensureArray((response._links &amp;&amp; response._links.item) || []);

        // load all the embedded items
        embeddedItems.forEach(function(i) {
            self.createNode({
                serializedEntity: i
            });
        });
				ozpIwc.log.debug(self.logPrefix+&quot; processed &quot; + embeddedItems.length + &quot; items embedded in the endoint&quot;);
        var unknownLinks=linkedItems.map(function(i) { return i.href;});
        unknownLinks=unknownLinks.filter(function(href) {
                return ozpIwc.object.values(self.data,function(k,node) {
                    return node.self === href;
                }).length === 0;
            });
				ozpIwc.log.debug(self.logPrefix+&quot; loading &quot; + unknownLinks.length + &quot; linked items&quot;);

				// empty array resolves immediately, so no check needed
        return Promise.all(unknownLinks.map(function(l) {
            return endpoint.get(l,headers).then(function(data) {
                self.createNode({
                    serializedEntity: data.response,
                    serializedContentType: data.header[&#x27;Content-Type&#x27;]
                });
            }).catch(function(err) {
							ozpIwc.log.info(self.logPrefix+&quot;Could not load from &quot;+l+&quot; -- &quot;,err);
						});
        }));

    }).catch(function(err) {
			ozpIwc.log.info(self.logPrefix+&quot; couldn&#x27;t load from endpoint &quot;+endpoint.name +&quot; -- &quot;,err);
		});
};


//===============================================================
// Default Routes and Subclass Helpers
//===============================================================
/**
 * Gathers the collection data for a node given its pattern only if it has a pattern.
 * @method getCollection
 * @param {String} pattern
 * @returns {Array}
 */
ozpIwc.ApiBase.prototype.getCollection = function(pattern){
    if(pattern) {
        return this.matchingNodes(pattern).filter(function (node) {
            return !node.deleted;
        }).map(function (node) {
            return node.resource;
        });
    } else {
        return [];
    }
};

/**
 * A collection of default action handlers for an API.
 * @property defaultHandler
 * @static
 * @type {Object}
 */
ozpIwc.ApiBase.defaultHandler={
    &quot;get&quot;:function(packet,context,pathParams) {
        var p =  context.node.toPacket();
        p.collection = this.getCollection(p.pattern);
        return p;
    },
    &quot;set&quot;:function(packet,context,pathParams) {
        context.node.set(packet);
        return { response: &quot;ok&quot; };
    },
    &quot;delete&quot;: function(packet,context,pathParams) {
        if(context.node) {
            context.node.markAsDeleted(packet);
        }

        return { response: &quot;ok&quot; };
    },
    &quot;list&quot;: function(packet,context,pathParams) {
        var entity=this.matchingNodes(packet.resource).filter(function(node){
            if(node.deleted) {
                return false;
            }
            return true;
        }).map(function(node) {
            return node.resource;
        });
        return {
            &quot;contentType&quot;: &quot;application/json&quot;,
            &quot;entity&quot;: entity
        };
    },
    &quot;bulkGet&quot;: function(packet,context,pathParams) {
        var self = this;
        var entity=this.matchingNodes(packet.resource).map(function(node) {
            var p =  node.toPacket();
            p.collection = self.getCollection(p.pattern);
            return p;
        });
        // TODO: roll up the permissions of the nodes, as well
        return {
            &quot;contentType&quot;: &quot;application/json&quot;,
            &quot;entity&quot;: entity
        };
    },
    &quot;watch&quot;: function(packet,context,pathParams) {
        this.addWatcher(packet.resource,{
            src: packet.src,
            replyTo: packet.msgId
        });

        //Only if the node has a pattern applied will it actually be added as a collector.
        this.addCollector(context.node);

        if(context.node) {
            var p =  context.node.toPacket();
            p.collection = this.getCollection(p.pattern);
            return p;
        } else {
            return { response: &quot;ok&quot;};
        }
    },
    &quot;unwatch&quot;: function(packet,context,pathParams) {
        this.removeWatcher(packet.resource, packet);

        //If no one is watching the resource any more, remove its collector if it has one to speed things up.
        if(context.node &amp;&amp; this.watchers[packet.resource] &amp;&amp; this.watchers[packet.resource].length === 0){
            this.removeCollector(context.node);
        }

        return { response: &quot;ok&quot; };
    }
};

/**
 * A list of all of the default actions.
 * @property allActions
 * @static
 * @type {String[]}
 */
ozpIwc.ApiBase.allActions=Object.keys(ozpIwc.ApiBase.defaultHandler);

/**
 * Install the default handler and filters for the provided actions and resources.
 * @method useDefaultRoute
 * @static
 * @param {String | String[]} actions
 * @param {String} resource=&quot;{resource:.*}&quot; The resource template to install the default handler on.
 */


/**
 * Creates a subclass of ApiBase and adds some static helper functions.
 *
 * @method createApi
 * @param {Function} init the constructor function for the class
 * @return {Object} A new API class that inherits from the ApiBase class.
 */
ozpIwc.createApi=function(init) {
    var api=ozpIwc.util.extend(ozpIwc.ApiBase,function() {
        ozpIwc.ApiBase.apply(this, arguments);
        return init.apply(this,arguments);
    });
    ozpIwc.PacketRouter.mixin(api);
    api.useDefaultRoute=function(actions,resource) {
        resource = resource || &quot;{resource:.*}&quot;;
        actions=ozpIwc.util.ensureArray(actions);
        actions.forEach(function(a) {
            var filterFunc=ozpIwc.standardApiFilters.forAction(a);
            api.declareRoute({
                action: a,
                resource: resource,
                filters: (filterFunc?filterFunc():[])
            },ozpIwc.ApiBase.defaultHandler[a]
            );
        });
    };

    api.declareRoute({
        action: [&quot;bulkSend&quot;],
        resource: &quot;{resource:.*}&quot;,
        filters: []
    }, function(packet, context, pathParams) {
        var messages = packet.entity || [];
        var self = this;

        messages.forEach(function(message){
            var packetContext=new ozpIwc.TransportPacketContext({
                &#x27;packet&#x27;:message.packet,
                &#x27;router&#x27;: self.router,
                &#x27;srcParticipant&#x27;: message.packet.src,
                &#x27;dstParticipant&#x27;: self.address
            });
            self.receiveRequestPacket(packetContext);
        });
        return { response: &quot;ok&quot;};
    });
    return api;
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
